<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/adminlte.min.css">
    <link rel="stylesheet" href="plugins/daterangepicker/daterangepicker.css">
    <style>
        .active p button{
            background-color: #343a40;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed layout-navbar-fixed layout-footer-fixed">
<div class="wrapper">

    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-dark">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/" class="nav-link">Home</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/alarms" class="nav-link">Alarms</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/integrated-data" class="nav-link">Integrated Data</a>
            </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
            <!-- Navbar Search -->
            <li class="nav-item">
                <a class="nav-link" data-widget="navbar-search" href="#" role="button">
                    <i class="fas fa-search"></i>
                </a>
                <div class="navbar-search-block">
                    <form class="form-inline">
                        <div class="input-group input-group-sm">
                            <input class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
                            <div class="input-group-append">
                                <button class="btn btn-navbar" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-navbar" type="button" data-widget="navbar-search">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </li>

            <!-- Messages Dropdown Menu -->
            <!-- Notifications Dropdown Menu -->
            <li class="nav-item">
                <a class="nav-link" data-widget="fullscreen" href="#" role="button">
                    <i class="fas fa-expand-arrows-alt"></i>
                </a>
            </li>
        </ul>
    </nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="" class="brand-link">
            <img src="dist/img/default-150x150.png" alt="Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
            <span class="brand-text font-weight-light">Test Ime</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">

            <!-- SidebarSearch Form -->
            <div class="form-inline">
                <div class="input-group" data-widget="sidebar-search">
                    <input class="form-control form-control-sidebar" type="search" placeholder="Search" aria-label="Search">
                    <div class="input-group-append">
                        <button class="btn btn-sidebar ">
                            <i class="fas fa-search fa-fw"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar Menu -->
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar text-sm flex-column nav-child-indent" data-widget="treeview" role="menu" data-accordion="false">
                    <!-- Add icons to the links using the .nav-icon class
                         with font-awesome or any other icon font library -->
                    <li class="nav-item menu-open">
                        <a href="#" class="nav-link">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <p>
                                Devices
                                <i class="right fas fa-angle-left"></i>
                            </p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>
                                        Device 1

                                    </p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link active">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Device 2</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Device 3</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Device 4</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Device 5 </p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Device 6</p>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <form id="form_graph" method="GET">
                        <li class="nav-header"><i class="nav-icon fas fa-sliders-h mr-2"></i>PARAMETERS</li>
                        <li class="nav-item">
                            <a href="" class="nav-link">
                                <div class="custom-control custom-checkbox sidebar-checkbox" style="margin-left: 0.55rem">
                                    <input class="custom-control-input" name="variables" value="parameter1" type="checkbox" id="parameter1" checked="">
                                    <label style="font-weight: normal" for="parameter1" class="custom-control-label">Parameter 1</label>
                                </div>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="" class="nav-link">
                                <div class="custom-control custom-checkbox sidebar-checkbox" style="margin-left: 0.55rem">
                                    <input class="custom-control-input" name="variables" value="parameter2" type="checkbox" id="parameter2">
                                    <label style="font-weight: normal" for="parameter2" class="custom-control-label">Parameter 2</label>
                                </div>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="" class="nav-link">
                                <div class="custom-control custom-checkbox sidebar-checkbox" style="margin-left: 0.55rem">
                                    <input class="custom-control-input" name="variables" value="parameter3" type="checkbox" id="parameter3" >
                                    <label style="font-weight: normal" for="parameter3" class="custom-control-label">Parameter 3</label>
                                </div>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="" class="nav-link">
                                <div class="custom-control custom-checkbox sidebar-checkbox" style="margin-left: 0.55rem">
                                    <input class="custom-control-input" name="variables" value="parameter4" type="checkbox" id="parameter4" >
                                    <label style="font-weight: normal" for="parameter4" class="custom-control-label">Parameter 4</label>
                                </div>
                            </a>
                        </li>
                    </form>
                </ul>
            </nav>
            <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">Device name</h1>
                    </div><!-- /.col -->
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="#">Home</a></li>
                            <li class="breadcrumb-item active">Dashboard </li>
                        </ol>
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <!-- AREA CHART -->
                        <div class="card card-secondary" style="height: auto">
                            <div class="card-header">
                                <h3 class="card-title">Chart</h3>

                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button type="button" class="btn btn-tool" data-card-widget="remove">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <form id="daysFilter" method="GET">
                                    <div class="form-group col-lg-6 col-md-6">
                                        <label>Date range:</label>

                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                              <span class="input-group-text">
                                                <i class="far fa-calendar-alt"></i>
                                              </span>
                                            </div>
                                            <input type="text" class="form-control float-right" id="daterange">
                                        </div>

                                        <!-- /.input group -->
                                    </div>
                                    <!-- /.card-body -->
                                </form>
                                <div style="overflow: scroll;height:auto;">
                                    <div style="max-height: 60%;width: auto" class="">
                                        <canvas id="myChart" height="120" class=""></canvas>
                                    </div>
                                </div>
                            </div>
                            <!-- /.card-body -->
                        </div>
                        <button type="button" class="btn btn-primary" onclick="downloadPDF2()">Get PDF</button>
                        <button type="button" onclick="reportBtn({{device.id}})" class="btn btn-primary">Report</button>
                    </div>
                </div>
                <!-- /. row -->
            </div><!-- /.container-fluid -->
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->

    <!-- Main Footer -->
    <footer class="main-footer">
        <strong>Sva prava zadr≈æana &copy; 2021</strong>
        <div class="float-right d-none d-sm-inline-block">
            <b>Version</b> 1.0
        </div>
    </footer>
</div>
<!-- ./wrapper -->

<!-- REQUIRED SCRIPTS -->
<!-- jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>

<!-- Bootstrap -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- overlayScrollbars -->
<script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.js"></script>

<!-- PAGE PLUGINS -->
<script src="plugins/moment/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
<script src="plugins/daterangepicker/daterangepicker.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.1.1/chartjs-plugin-zoom.min.js" integrity="sha512-NxlWEbNbTV6acWnTsWRLIiwzOw0IwHQOYUCKBiu/NqZ+5jSy7gjMbpYI+/4KvaNuZ1qolbw+Vnd76pbIUYEG8g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
<script>
    $('#daterange').on('apply.daterangepicker', (e, picker) => {
        //moment objects for date difference
        var start = moment(picker.startDate.format('YYYY-MM-DD'));
        var end   = moment(picker.endDate.format('YYYY-MM-DD'));
        //variables for ajax
        var startDate = start.toDate();
        var endDate = end.toDate();
        //n days
        var diff = end.diff(start, 'days');
        var lastnumber = 1;
        checked_values= getSelectedCheckboxValues('variables')
        $.ajax({
            // GET is a default
            type: 'GET',
            crossDomain: true,
            dataType: 'json',
            cache: false,
            url: 'http://optika.bax/api/1/data',
            data:{"checked_variables" : checked_values, 'device_id':lastNumber, start: startDate, end: endDate, days: diff},
            success: function (response) {
                const temporary = [...response['labels']]; //because I change the response labels i stored a copy
                // filling the labels with appropriate labels for n days
                for(i=1;i<diff+1;i++){
                    //using i=1 due to conflicts with default chart 0 point
                    response.labels[response.labels.length] = i.toString()  //adding cut for vertical line
                    response['labels'] = response['labels'].concat(temporary.slice(0)); //adding labels for every n to array
                    console.log(response.labels, i, diff)
                }
                response.labels.pop(); // I need to pop a 0 that appears at the end of the array until I figure out why
                setChart(response, diff)    //added diff parameter to function for later calculation
            },
            error: function (response) {
                alert("Error with  the URL and database")
                console.log("Error with  the URL and database")
                console.log(response.status)
                //console.log(response)
            }
        });

    });
    var date2 = new Date();
    date2.setDate(date2.getDate());
    $('#daterange').daterangepicker({
        timePicker: false,
        maxDate: date2,
        timePickerIncrement: 30,
        locale: {
            format: 'DD/MM/YYYY',
            cancelLabel: 'Clear'
        }
    });
    //  We first initialize an empty line graph ready to be drawn on
    //  I don't use a function here as getting the chart object for updating proved troublesome
    var ctxL = document.getElementById("myChart").getContext('2d');
    var gradientFill = ctxL.createLinearGradient(0, 0, 0, 290);
    gradientFill.addColorStop(0, "rgba(173, 53, 186, 1)");
    gradientFill.addColorStop(1, "rgba(173, 53, 186, 0.1)");

    var myLineChart = new Chart(ctxL, {
        type: 'line',
        data: {
        },
        options: {
            responsive: true,
            width: 'auto',
            height: 400,
            plugins: {
                zoom: {
                    zoom: {
                        wheel: {
                            enabled: true,
                        },
                        drag: {
                            enabled: true,
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'xy',
                    },
                    pan: {
                        enabled: true,
                    },
                }
            }
        }
    });

    /*  On page load we send the default selected parameter to our api and receive the graph data   */
    $( document ).ready(function() {
        lastNumber = 1; /* This variable was kept from the docx, I only made it static for my own testing purposes */
        checked_values= getSelectedCheckboxValues('variables') /* We get the checked parameters from the sidebar */
        $.ajax({
            // GET is a default
            type: 'GET',
            crossDomain: true,
            dataType: 'json',
            cache: false,
            // I used my own api for testing and therefore it should be changed accordingly
            url: 'http://optika.bax/api/'+lastNumber+"/data",
            data:{"checked_variables" : checked_values, 'device_id':lastNumber, 'ts': sample_time},
            success: function (response) {
                /*  we call the graph drawing function  */
                setChart(response)
            },
            error: function (response) {
                alert("Error with  the URL and database")
                console.log("Error with  the URL and database")
                console.log(response.status)
                //console.log(response)
            }
        });
    });

    // Placeholder button meant to later be used to redirect to the report
    function reportBtn(id) {
        var checked_variables = getSelectedCheckboxValues('variables')
        $.ajax({
            type: 'GET',
            crossDomain: true,
            dataType: 'json',
            cache: false,
            url: '/get-report',
            data: {"device_id": id, 'variables': checked_variables},
            success: function (response) {

            },
            error: function (response) {

            }
        })
    }
    /*  PDF download for the chart */
    function downloadPDF2() {
        var newCanvas = document.querySelector('#myChart');
        var newCanvasImg = newCanvas.toDataURL("image/png", 1.0);
        var doc = new jspdf.jsPDF('landscape');
        doc.text(15, 15, "Report");
        doc.addImage(newCanvasImg, 'PNG', 10, 10, 280, 150 );
        doc.save('new-canvas.pdf');
    }

    // We get the selected values from the sidebar parameters
    function getSelectedCheckboxValues(name) {
        const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
        let values = [];
        checkboxes.forEach((checkbox) => {
            values.push(checkbox.value);
        });
        return values;
    }

    /*
      Function 'getValues()' invoked each N seconds where request is sent to the server (localhost/id/data)
      - used to preview default chart (Pmax for example)
      - used to preview char of clicked variable from dropdown list
    */
    var sample_time= 3000
    /*
    window.setTimeout(function () {
      getValues()
      window.location.reload();
      //var myVar = setInterval(getValues, sample_time);
    }, sample_time);
    */
    /*
      Show default graph
    */

    // This gets called whenever we check or uncheck a parameter in the sidebar
    $('#form_graph :input').on('change',function(e){
        e.preventDefault()
        checked_values= getSelectedCheckboxValues('variables')
        if (checked_values.length === 0) {
            alert("You need to specify variable")
            console.log("Array is empty!")
            return 0
        }
        // GET AJAX request
        var form = $(this).closest("form");
        var lastNumber = window.location.href.match(/\d+$/);
        lastNumber = 1; /*I changed this for my own testing purposes, can be deleted later*/
        $.ajax({
            // GET is a default
            type: 'GET',
            crossDomain: true,
            dataType: 'json',
            cache: false,
            // I used my own api for testing and therefore it should be changed accordingly
            url: 'http://optika.bax/api/'+lastNumber+"/data",
            data:{"checked_variables" : checked_values, 'device_id':lastNumber, 'ts': sample_time},
            success: function (response) {
                // caling the chart draw function
                setChart(response)
            },
            error: function (response) {
                alert("Error with  the URL and database")
                console.log("Error with  the URL and database")
                console.log(response.status)
                //console.log(response)
            }
        });
    });
    // generating random colors for the graph lines
    function random_rgba() {
        colors = Math.floor(Math.random() * 255) + ',' + Math.floor(Math.random() * 255) + ',' + Math.floor(Math.random() * 255) + ',';
        return colors ;
    }

    // custom function used to update the graph according to the selected parameters
    // we get the response from our api
    function setChart(response, days) {
        console.log(response)
        var ctxL = document.getElementById("myChart").getContext('2d');
        var chartData = []; // this will contain our chart datasets
        var annotation_data = [];   // this will contain our chart annotations/set_points

        //minxmaxpoints will be used to set the prefered maximum and minimum y-axis based on set points
        // we sort this from MIN to MAX value
        const minmaxpoints = [...response.set_points].sort(function(a, b) {
            return a - b;
        });
        // We again sort so that there are no null values
        const minmaxresults = minmaxpoints.filter(function(x) {
            return x !== null;
        });
        // Finally if the condition is met, we make a dataset to be used later for graph options
        if(minmaxresults.length > 0){
            var yaxesdata = {
                suggestedMax: minmaxresults[minmaxresults.length-1] + Math.round(minmaxresults[minmaxresults.length-1]/10),
                suggestedMin: minmaxresults[0] - Math.round(minmaxresults[0]/10),
            };
            myLineChart.options.scales.y = yaxesdata;
        }

        // We make a dataset for every selected variable
        response.variable.forEach(function(e, index){
            console.log(e, index);
            var gradientFill = ctxL.createLinearGradient(0, 0, 0, 290);
            var colors = random_rgba();
            gradientFill.addColorStop(0, "rgba("+colors+ "1)");
            gradientFill.addColorStop(1, "rgba("+colors+ "0.1)");
            // We push each dataset into an array using our response data
            chartData.push(
                {
                    label: e+' ('+ (response.set_points[index] != null ? response.set_points[index] : 'No set point') +') ',
                    data: response.data[e],
                    backgroundColor: gradientFill,
                    borderColor: [
                        "rgba("+colors+ "1)",
                    ],
                    borderWidth: 2,
                    pointBorderColor: "rgba("+colors+ "1)",
                    pointBackgroundColor: "#000",
                }
            )
            //  we check if there are multiple days and generate annotations for x accordingly
            if(days){
                for (i=1; i<days+1; i++){
                    annotation_data.push({
                        type: 'line',
                        mode: 'vertical',
                        scaleID: 'x',
                        xMin: i.toString(),
                        xMax: 300,
                        value: i.toString(),
                        borderColor: [
                            "black",
                        ],
                        borderDash: [5, 5],
                        borderWidth: 2
                    })
                }
            }
            // We check if this parameter has a set_point
            if(response.set_points[index] != null){
                // We use the annotations plugin for chart.js
                // And we push the annotation dataset into an array
                annotation_data.push({
                    type: 'line',
                    mode: 'horizontal',
                    scaleID: 'y-axis',
                    yMin: response.set_points[index],
                    yMax: response.set_points[index],
                    borderColor: [
                        "rgba("+colors+ "1)",
                    ],
                    borderDash: [5, 5],
                    borderWidth: 1,
                    label: {
                        enabled: true,
                        content: response.set_points[index]
                    }
                })
            }
        });
        // We finally set the data and options for our CHART and call the built in update() function to draw it
        myLineChart.options.plugins.annotation.annotations = annotation_data;
        myLineChart.data.datasets = chartData;
        myLineChart.data.labels = response.labels;
        myLineChart.update();
    }
</script>
</body>
</html>
