<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
    <!-- select2 -->
    <link rel="stylesheet" href="plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/adminlte.min.css">
    <style>
        .active p button{
            background-color: #343a40;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed layout-navbar-fixed layout-footer-fixed">
<div class="wrapper">

    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-dark">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/" class="nav-link">Home</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/alarms" class="nav-link">Alarms</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/integrated-data" class="nav-link">Integrated Data</a>
            </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
            <!-- Navbar Search -->
            <li class="nav-item">
                <a class="nav-link" data-widget="navbar-search" href="#" role="button">
                    <i class="fas fa-search"></i>
                </a>
                <div class="navbar-search-block">
                    <form class="form-inline">
                        <div class="input-group input-group-sm">
                            <input class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
                            <div class="input-group-append">
                                <button class="btn btn-navbar" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-navbar" type="button" data-widget="navbar-search">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </li>

            <!-- Messages Dropdown Menu -->
            <!-- Notifications Dropdown Menu -->
            <li class="nav-item">
                <a class="nav-link" data-widget="fullscreen" href="#" role="button">
                    <i class="fas fa-expand-arrows-alt"></i>
                </a>
            </li>
        </ul>
    </nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="" class="brand-link">
            <img src="dist/img/default-150x150.png" alt="Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
            <span class="brand-text font-weight-light">Test Ime</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">

            <!-- SidebarSearch Form -->
            <div class="form-inline">
                <div class="input-group" data-widget="sidebar-search">
                    <input class="form-control form-control-sidebar" type="search" placeholder="Search" aria-label="Search">
                    <div class="input-group-append">
                        <button class="btn btn-sidebar ">
                            <i class="fas fa-search fa-fw"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar Menu -->
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar text-sm flex-column nav-child-indent" data-widget="treeview" role="menu" data-accordion="false">
                    <!-- Add icons to the links using the .nav-icon class
                         with font-awesome or any other icon font library -->
                    <li class="nav-item menu-open">
                        <a href="#" class="nav-link">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <p>
                                Devices
                                <i class="right fas fa-angle-left"></i>
                            </p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>
                                        Device 1

                                    </p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link active">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Device 2</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Device 3</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Device 4</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Device 5 </p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Device 6</p>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
            <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">Device name</h1>
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <!-- AREA CHART -->
                        <div class="card card-secondary" style="height: auto">
                            <div class="card-header">
                                <h3 class="card-title">Chart</h3>

                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button type="button" class="btn btn-tool" data-card-widget="remove">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <form id="select_form" method="GET">
                                    <div class="card-body row">
                                        <div class="form-group col-md-4">
                                            <label for="parameter">Parameter</label>
                                            <select class="form-control select2bs4" data-placeholder="Select parameter" name="parameter" id="parameter" style="width: 100%;">
                                                <option selected disabled></option>
                                                <option value="1">Param 1</option>
                                                <option value="2">Param 2</option>
                                                <option value="3">Param 3</option>
                                                <option value="4">Param 4</option>
                                                <option value="5">Param 5</option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label for="parameter">Devices</label>
                                            <select class="form-control select2bs4" multiple name="device[]" id="devices" style="width: 100%;" disabled>

                                            </select>
                                        </div>
                                        <div class="col-md-12">
                                            <button type="submit" class="btn btn-primary float-right">Draw Chart</button>
                                        </div>
                                    </div>
                                    <!-- /.card-body -->
                                </form>
                                <div style="max-height: 60%" class="chart">
                                    <canvas id="myChart" height="120" class="chartjs-render-monitor"></canvas>
                                </div>
                            </div>
                            <!-- /.card-body -->
                        </div>
                        <button type="button" class="btn btn-primary" onclick="downloadPDF2()">Get PDF</button>
                    </div>
                </div>
                <!-- /. row -->
            </div><!-- /.container-fluid -->
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->

    <!-- Main Footer -->
    <footer class="main-footer">
        <strong>Sva prava zadržana &copy; 2021</strong>
        <div class="float-right d-none d-sm-inline-block">
            <b>Version</b> 1.0
        </div>
    </footer>
</div>
<!-- ./wrapper -->

<!-- REQUIRED SCRIPTS -->
<!-- jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- overlayScrollbars -->
<script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.js"></script>

<!-- PAGE PLUGINS -->
<!-- select2 -->
<script src="plugins/select2/js/select2.min.js"></script>

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.1.1/chartjs-plugin-zoom.min.js" integrity="sha512-NxlWEbNbTV6acWnTsWRLIiwzOw0IwHQOYUCKBiu/NqZ+5jSy7gjMbpYI+/4KvaNuZ1qolbw+Vnd76pbIUYEG8g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
<script>
    $("#parameter").on('change', function(e){
        var value = $(this).val()
        $.ajax({
            // GET is a default
            type: 'GET',
            crossDomain: true,
            dataType: 'json',
            cache: false,
            url: 'http://optika.bax/api/get-devices',
            data:{'parameter_id' : value},
            success: function (response) {
                /*API mi vrati svaki device sa id,name koji ima odabrani parametar*/
                var options=[];
                response.data.forEach(function (e, index) {
                    options.push(
                        {id: e.name, text: e.name}
                    )
                })
                console.log(options);
                $('#devices').prop('disabled', false).select2({
                    data: options
                })
            },
            error: function (response) {
                alert("Error with  the URL and database")
                console.log("Error with  the URL and database")
                console.log(response.status)
            }
        });
    })
    $("#select_form").on('submit', function(e){
        e.preventDefault();
        var devices = $('#devices').select2('val');
        if (devices.length === 0) {
            alert("No devices selected!")
            console.log("Array is empty!")
            return 0
        }
        console.log(devices, 'select2 data')
        $.ajax({
            // GET is a default
            type: 'GET',
            crossDomain: true,
            dataType: 'json',
            cache: false,
            url: 'http://optika.bax/api/parameter-data',
            data:{'devices' : devices},
            success: function (response) {
                console.log(response, 'response apija za crtanje')
                setChart(response)
            },
            error: function (response) {
                alert("Error with  the URL and database")
                console.log("Error with  the URL and database")
                console.log(response.status)
            }
        });
    })

    $('.select2bs4').select2({
        theme: 'bootstrap4',
        allowClear: true,
        placeholder: 'Select option',
        "language": {
            "noResults": function () {
                return "Nema pronađenih rezultata";
            }
        }
    });

    $('#device_name').on('change', function() {
        let parameterSelect = document.querySelector('#parameter');
        if($(this).val()) {
            $('#parameter').removeAttr('disabled');
            $('#parameter').val('').trigger('change');
        } else {
            parameterSelect.innerHTML = "";
            $('#parameter').attr('disabled', true);
            $('#parameter').val('').trigger('change');
        }
    });

    function downloadPDF2() {
        var newCanvas = document.querySelector('#myChart');
        var newCanvasImg = newCanvas.toDataURL("image/png", 1.0);
        var doc = new jspdf.jsPDF('landscape');
        doc.text(15, 15, "Report");
        doc.addImage(newCanvasImg, 'PNG', 10, 10, 280, 150 );
        doc.save('new-canvas.pdf');
    }
    /*  INITIALIZE GRAPH, UCITATI POCETNE PODATKE PO POTREBI    */
    var ctxL = document.getElementById("myChart").getContext('2d');
    var gradientFill = ctxL.createLinearGradient(0, 0, 0, 290);
    gradientFill.addColorStop(0, "rgba(173, 53, 186, 1)");
    gradientFill.addColorStop(1, "rgba(173, 53, 186, 0.1)");

    var myLineChart = new Chart(ctxL, {
        type: 'line',
        data: {
            labels: ["0", "15", "30", "45", "1h", "1:15", "1:30"], // dummy data
            datasets: [
                {
                    label: "Atribut1",
                    data: [0, 65, 45, 65, 35, 65, 0],
                    backgroundColor: gradientFill,
                    borderColor: ["#AD35BA"],
                    borderWidth: 2,
                    pointBorderColor: "#fff",
                    pointBackgroundColor: "rgba(173, 40, 150, 0.1)",
                }
            ]
        },
        options: {
            responsive: true,
            height: 400,
            plugins: {
                zoom: {
                    zoom: {
                        wheel: {
                            enabled: true,
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'xy',
                    },
                    pan: {
                        enabled: true,
                    },
                }
            }
        }
    });

    /*
      Function 'getValues()' invoked each N seconds where request is sent to the server (localhost/id/data)
      - used to preview default chart (Pmax for example)
      - used to preview char of clicked variable from dropdown list
    */
    var sample_time= 3000
    /*
    window.setTimeout(function () {
      getValues()
      window.location.reload();
      //var myVar = setInterval(getValues, sample_time);
    }, sample_time);
    */
    /*
      Show default graph
    */

    function random_rgba() {
        colors = Math.floor(Math.random() * 255) + ',' + Math.floor(Math.random() * 255) + ',' + Math.floor(Math.random() * 255) + ',';
        return colors ;
    }

    function setChart(response) {
        console.log(response)
        var ctxL = document.getElementById("myChart").getContext('2d');
        var chartData = [];
        var annotation_data = [];
        response.devices.forEach(function(e, index){
            console.log(e, index);
            colors = random_rgba();
            var gradientFill = ctxL.createLinearGradient(0, 0, 0, 290);
            var colors = random_rgba();
            gradientFill.addColorStop(0, "rgba("+colors+ "1)");
            gradientFill.addColorStop(1, "rgba("+colors+ "0.1)");
            chartData.push(
                {
                    label: e,
                    data: response.data[e],
                    backgroundColor: gradientFill,
                    borderColor: [
                        "rgba("+colors+ "1)",
                    ],
                    borderWidth: 2,
                    pointBorderColor: "rgba("+colors+ "1)",
                    pointBackgroundColor: "#000",
                }
            )
        });
        myLineChart.data.datasets = chartData;
        myLineChart.data.labels = response.labels;
        myLineChart.update();
    }
</script>
</body>
</html>
